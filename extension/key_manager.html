<html>
<head>
<title>WebPG Key Manager</title>
<link type="text/css" href="jquery/css/dot-luv/jquery-ui-1.8.14.custom.css" rel="stylesheet" />
<script type="text/javascript" src="jquery/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery.passwordStrength.js"></script>
<script type="text/javascript">
/* <![CDATA[ */

var ext = chrome.extension.getBackgroundPage();

$(function(){

    key_algorithm_types = {
        "RSA": "R",
        "DSA": "D",
        "ELG-E": "g",
    }


    function isValidEmailAddress(emailAddress) {
        var pattern = new RegExp(/^(("[\w-\s]+")|([\w-]+(?:\.[\w-]+)*)|("[\w-\s]+")([\w-]+(?:\.[\w-]+)*))(@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$)|(@\[?((25[0-5]\.|2[0-4][0-9]\.|1[0-9]{2}\.|[0-9]{1,2}\.))((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){2}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\]?$)/i);
        return pattern.test(emailAddress);
    };

    $('#tab-2-btn').click(function(){
        if (!window.private_built) {
            $("#dialog-modal").dialog({
                height: 140,
                modal: true,
                autoOpen: true,
                title: "Building Keylist"
            }).children()[0].innerHTML = "Please wait while build the keylist.";
            setTimeout( function(){ buildKeylist(keylist=null, 'private'); $("#dialog-modal").dialog('destroy');}, 10);
        }
        window.private_built = true;
    });

    $('#tab-3-btn').click(function(){
        if (!window.public_built) {
            $("#dialog-modal").dialog({
                height: 140,
                modal: true,
                autoOpen: true,
                title: "Building Keylist"
            }).children()[0].innerHTML = "Please wait while build the keylist.";
            setTimeout( function(){ buildKeylist(keylist=null, 'public'); $("#dialog-modal").dialog('destroy');}, 10);
        }
        window.public_built = true;
    });

    // Begin public keylist generation
    function buildKeylist(keyList, type, openKey, openSubkey, openUID){
        console.log(keyList, type, openKey, openSubkey, openUID);

        if (type == 'public') {
            keylist_element = document.getElementById('public_keylist');
        } else {
            keylist_element = document.getElementById('private_keylist');
            enabled_keys = window.ext.webpg_prefs.enabled_keys.get();
        }

        if (!keyList) {
            if (type == 'public') {
                var keylist = window.ext.plugin.getPublicKeyList();
                if (!keylist) {
                    // if the parsing failed, create an empty keylist
                    keylist = {};
                }
            }
            var pkeylist = window.ext.plugin.getPrivateKeyList();

            if (!pkeylist) {
                // if the parsing failed, create an empty keylist
                pkeylist = {};
            }
            window.pkeylist = pkeylist;
        }

        keylist_element.innerHTML = "<div class='ui-accordion-left'></div>";

        if (type == 'private') {
            // Create the key-generate button and dialog
            genkey_div = document.createElement('div');
            genkey_div.style.padding = "8px 0 20px 0";
            genkey_button = document.createElement('input');
            genkey_button.setAttribute('value', 'Generate New Key');
            genkey_button.setAttribute('type', 'button');
            $(genkey_button).button().click(function(e){
                window.genkey_refresh = false;
                $("#genkey-dialog").dialog({
                    "buttons": {
                        "Create": function() {
                            form = $(this).find("#genkey-form")[0];
                            $(form).parent().before("<div id=\"genkey-status\"> </div>");
                            error = "";
                            if (!form.uid_0_name.value){
                                error += "Name Required<br>";
                                $(form.uid_0_name).addClass("ui-state-error");
                            }
                            if (form.uid_0_name.value.length < 5){
                                error += "UID Names must be at least 5 characters<br>";
                                $(form.uid_0_name).addClass("ui-state-error");
                            } else {
                                $(form.uid_0_name).removeClass("ui-state-error");
                            }
                            if (!isNaN(form.uid_0_name.value[0])){
                                error += "UID Names cannot begin with a number<br>";
                                $(form.uid_0_name).addClass("ui-state-error");
                            } else {
                                $(form.uid_0_name).removeClass("ui-state-error");
                            }
                            if (form.uid_0_email.value && !isValidEmailAddress(form.uid_0_email.value)){
                                error += "Not a valid email address<br>";
                                $(form.uid_0_email).addClass("ui-state-error");
                            } else {
                                $(form.uid_0_email).removeClass("ui-state-error");
                            }
                            if (form.passphrase.value != form.pass_repeat.value){
                                $(form.passphrase).addClass("ui-state-error");
                                $(form.pass_repeat).addClass("ui-state-error");
                                $(form.passphrase).next()
                                    .find("#passwordStrength-text")
                                    .html("Passphrases do not match")
                                    .css({"color": "#f00"});
                                error += "Passphrases do not match<br>";
                            } else {
                                $(form.passphrase).removeClass("ui-state-error");
                                $(form.pass_repeat).removeClass("ui-state-error");
                            }
                            if (error.length) {
                                $("#genkey-status").html(error)[0].style.display="block";
                                $("#genkey-dialog").dialog("option", "minHeight", 350);
                                return false;
                            }
                            window.genkey_waiting = true;
                            chrome.extension.onConnect.addListener(function(port) {
                                port.onMessage.addListener(function(msg) {
                                    if (msg.type == "progress") {
                                        data = msg.data;
                                        if (!isNaN(data))
                                            data = String.fromCharCode(data);
                                        data += " ";
                                        if($("#genkey_progress"))
                                            $("#genkey_progress")[0].innerHTML += data;
                                        if(data == "complete" || data == "complete ") {
                                            window.genkey_refresh = true;
                                            window.genkey_waiting = false;
                                            new_pkeylist = window.ext.plugin.getPrivateKeyList();
                                            generated_key = null;
                                            for (key in new_pkeylist) {
                                                if (key in window.pkeylist == false) {
                                                    generated_key = key;
                                                    break;
                                                }
                                            }
                                            buildKeylist(null, "private", generated_key, null, null);
                                            $("#genkey-status_detail").remove()
                                            $("#genkey-status").remove();
                                            $("#genkey-form")[0].reset();
                                            $("#genkey-form")[0].style.display="inline-block";
                                            $("#genkey-dialog").dialog("close");
                                        }
                                    }
                                });
                            });
                            $("#genkey-form").find(".open").trigger("click");
                            console.log("going to create a key with the following details:" + '\n' +
                                "Primary Key:", form.publicKey_algo.value + 
                                  ' (' + form.publicKey_size.value + ')\n' +
                                "Sub Key:", form.subKey_algo.value + 
                                  ' (' + form.subKey_size.value + ')\n' +
                                "name:", form.uid_0_name.value + '\n' +
                                "comment: [Comments not supported yet; this will be blank]\n" +
                                "email:", form.uid_0_email.value + '\n' +
                                "passphrase:", form.passphrase.value +  '\n' +
                                "expiration:", "Key will expire in " + form.key_expire.value + ' days');
                            $("#genkey-dialog").dialog("option", "minHeight", 300);
                            $("#genkey-status").html(error)[0].style.display="block";
                            $("#genkey-status").html("Building key, please wait..");
                            $("#genkey-status").after("<div id='genkey-status_detail' style=\"font-size: 12px; color:#fff;padding: 20px;\">This may take a long time (5 minutes or more) to complete depending on the selected options. Please be patient while the key is created. It is safe to close this window, key generation will continue in the background.<br><br><div id='genkey_progress' style='height:auto;display:block;'></div></div>");
                            $(form)[0].style.display = 'none';
                            $("#genkey-dialog")[0].style.height = "20";
                            $("#genkey-dialog")[0].style.display = "none";
                            response = ext.plugin.gpgGenKey(form.publicKey_algo.value,
                                form.publicKey_size.value,
                                form.subKey_algo.value,
                                form.subKey_size.value,
                                form.uid_0_name.value,
                                form.uid_0_comment.value,
                                form.uid_0_email.value,
                                form.key_expire.value,
                                form.passphrase.value
                            );
                            if (response == "queued") {
                                $("#genkey-dialog").dialog("option", "buttons", { 
                                    "Close": function() {
                                        $("#genkey-dialog").dialog("close");
                                    }
                                });
                            }
                        },
                        Cancel: function() {
                            $("#genkey-dialog").dialog("close");
                            if (window.genkey_refresh)
                                buildKeylist(null, 'private');
                        }
                    },
                });

                $("#genkey-form").children('input').removeClass('input-error');
                $("#genkey-form")[0].reset();
                $('.key-algo').each(function(){
                    $(this)[0].options.selectedIndex = $(this)[0].options.length - 1;
                    if ($(this).parent().next().find('.key-size').length) {
                        $(this).parent().next().find('.key-size')[0].children(0).disabled = true;
                        $($(this).parent().next().find('.key-size')[0].children(0)).hide();
                    }
                }).change(function(){
                    if ($(this)[0].options.selectedIndex == 0){
                        $(this).parent().next().find('.key-size')[0].children(0).disabled = false;
                        $($(this).parent().next().find('.key-size')[0].children(0)).show();
                        $(this).parent().next().find('.key-size')[0].children(4).disabled = true;
                        $($(this).parent().next().find('.key-size')[0].children(4)).hide();
                        $(this).parent().next().find('.key-size')[0].options.selectedIndex = 2;
                    } else if($(this)[0].options.selectedIndex == 1){
                        $(this).parent().next().find('.key-size')[0].options.selectedIndex = 2;
                        $(this).parent().next().find('.key-size')[0].children(0).disabled = false;
                        $($(this).parent().next().find('.key-size')[0].children(0)).show();
                        $(this).parent().next().find('.key-size')[0].children(4).disabled = false;
                        $($(this).parent().next().find('.key-size')[0].children(4)).show();
                    } else {
                        $(this).parent().next().find('.key-size')[0].children(0).disabled = true;
                        $($(this).parent().next().find('.key-size')[0].children(0)).hide();
                        $(this).parent().next().find('.key-size')[0].children(4).disabled = false;
                        $($(this).parent().next().find('.key-size')[0].children(4)).show();
                        $(this).parent().next().find('.key-size')[0].options.selectedIndex = 2;
                    }
                });
                $("#genkey-dialog").dialog('open');
                $("#genkey-form").find(".open").trigger("click");
            });
            $("#genkey-dialog").dialog({
                resizable: true,
                minHeight: 300,
                width: 630,
                modal: true,
                autoOpen: false
            });
            $('.passphrase').passwordStrength("#pass_repeat");
            genkey_div.appendChild(genkey_button);
            document.getElementById('private_keylist').appendChild(genkey_div);
            // End key generation dialog
            window.private_built = true;
        }

        var prev_key = null;
        current_keylist = (type == 'public')? keylist : pkeylist;
        for (key in current_keylist){
            if (type == 'public') {
                if (key in pkeylist) {
                    continue;
                }
            } else {
                keyobj = document.createElement('div');
                if (current_keylist[key].disabled)
                    keyobj.className = 'disabled';
                if (current_keylist[key].expired)
                    keyobj.className = 'invalid-key';
                if (current_keylist[key].invalid)
                    keyobj.className = 'invalid-key';
                if (current_keylist[key].revoked)
                    $(keyobj).addClass('invalid-key');
                keyobj.className += ' primary_key';
                enabled = (enabled_keys.indexOf(key) != -1) ? 'checked' : '';
                status_text = (enabled) ? "Enabled" : "Disabled";
                default_key = (key == window.ext.webpg_prefs.default_key.get()) ? 'checked' : '';
            }
            status = "Valid";
            keyobj = document.createElement('div');
            if (current_keylist[key].disabled) {
                $(keyobj).addClass('disabled');
                status = "Disabled";
            }
            if (current_keylist[key].expired) {
                $(keyobj).addClass('invalid-key');
                status = "Expired";
            }
            if (current_keylist[key].invalid) {
                $(keyobj).addClass('invalid-key');
                status = "Invalid";
            }
            if (current_keylist[key].revoked) {
                $(keyobj).addClass('invalid-key');
                status = "Revoked";
            }
            $(keyobj).addClass('primary_key');
            if (key == openKey) {
                $(keyobj).addClass('open_key');
                keyobj.setAttribute('id', 'open_key');
            }
            if (type == "public") {
                keyobj.innerHTML = "<h3 class='public_keylist'><a href='#'><span style='margin: 0;width: 50%'>" + current_keylist[key].name + "</span><span class='trust'></span></a></h3>";
            } else {
                keyobj.innerHTML = "<h3 class='private_keylist' style='height: 24px;'><a href='#'><span style='margin: 0;width: 50%;'>" + current_keylist[key].name + 
                    "&nbsp;&nbsp;-&nbsp;&nbsp;[0x" + key.substr(-8) + "]</span></a><span class='trust' style='z-index:1000; left: 12px; top:-28px;height:22px;'>" +
                    "<span class='keyoption-help-text' style=\"margin-right: 14px;\"></span>" +
                    "<input class='enable-check' id='check-" + key +"' type='checkbox' " + enabled + " onclick=\"if ('" + key + "' == window.ext.webpg_prefs.default_key.get()){" +
                    " $(this).next().addClass('ui-state-active'); return false }; if (this.checked && !window.ext.webpg_prefs.default_key.get()) { $(this).next().next().click(); $(this).next().next().next().addClass('ui-state-active'); } (this.checked) ? window.ext.webpg_prefs.enabled_keys.add('" + key + "') : " +
                    "window.ext.webpg_prefs.enabled_keys.remove('" + key + "'); (this.checked) ? $(this).button('option', 'label', 'Enabled') : $(this).button('option', " +
                    "'label', 'Disabled');\"/\><label for='check-" + key + "' style='z-index:100;'>" + status_text + "</label><input class='default-check' type='radio' name='default_key' " +
                    " id='default-" + key + "' " + default_key + "/\><label class='default-check' style='z-index: 0; margin-left: 0px;' for='default-" + key + "'>Set as default</label></span></h3>";
            }
            keylist_element.appendChild(keyobj);
            current_keylist[key].nuids = 0;
            for (uid in current_keylist[key].uids) {
                current_keylist[key].nuids += 1;
            }
            uidlist = document.createElement('div');
            uidlist.setAttribute('class', 'uidlist');
            uidlist.setAttribute('id', key);
            created_date = new Date(current_keylist[key].subkeys[0].created * 1000).toJSON().substring(0, 10);
            expiry = (current_keylist[key].subkeys[0].expires == 0) ? 'Never' : new Date(current_keylist[key].subkeys[0].expires * 1000).toJSON();
            if (current_keylist[key].subkeys[0].expires > 0) {
                expiry = (Math.round(new Date().getTime()/1000.0) > current_keylist[key].subkeys[0].expires) ? "Expired [" + expiry.substring(0, 10) + "]" : expiry.substring(0, 10);
            }
            options_list = [];
            if (type == "private") {
                option = {
                    "command" : "trust",
                    "text" : "Trust Assignment",
                    "input_type" : "list",
                    "list_values" : ["Unknown", "Never", "Marginal", "Full", "Ultimate"]
                }
                options_list[options_list.length] = option;
                option = {
                    "command" : "expire",
                    "text" : "Change Expiration",
                    "input_type" : "calendar"
                }
                options_list[options_list.length] = option;
                option = {
                    "command" : "passphrase",
                    "text" : "Change Passphrase",
                    "input_type" : "button"
                }
                options_list[options_list.length] = option;
                option = {
                    "command" : "adduid",
                    "text" : "Add UID",
                    "input_type" : "dialog"
                }
                options_list[options_list.length] = option;
                option = {
                    "command" : "addsubkey",
                    "text" : "Add Subkey",
                    "input_type" : "dialog"
                }
                options_list[options_list.length] = option;
            } else {
                option = {
                    "command" : "trust",
                    "text" : "Trust Assignment",
                    "input_type" : "list",
                    "list_values" : ["Unknown", "Never", "Marginal", "Full", "Ultimate"]
                }
                options_list[options_list.length] = option;
            }
            compiled_option_list = "";
            for (option_i in options_list){
                option = options_list[option_i];
                switch(option.input_type) {
                    case "button":
                        compiled_option_list += "<span class='uid-options' style='font-size:12px; display: '><input class='" + 
                            type + "-key-option-button' id='" + option.command + "-" + type + "-" + key + 
                                "' type='button' value='" + option.text + "'/\></span>";
                        break;
                    case "dialog":
                        compiled_option_list += "<span class='uid-options' style='font-size:12px;'><input class='" + 
                            type + "-key-option-button' id='" + option.command + "-" + type + "-" + key + 
                                "' type='button' value='" + option.text + "'/\></span>";
                        break;
                    case "calendar":
                        compiled_option_list += "<span class='uid-options' style='font-size:12px;'><input class='" + 
                            type + "-key-option-button' id='" + option.command + "-" + type + "-" + key + 
                                "' type='button' value='" + option.text + "'/\></span>";
                        break;
                    case "list":
                        compiled_option_list += "<span class='uid-options' style='font-size:12px;'>" +
                            "<label for='" + option.command + "-" + type + "-" + key + 
                            "' style=\"display:block; clear:right; margin-top: -10px;\">" + option.text + "</label><select class='" + 
                            type + "-key-option-list ui-button ui-corner-all ui-button ui-widget ui-state-default' id='" + 
                            option.command + "-" + type + "-" + key + "' style=\"margin-right: 10px;\">"
                        for (listitem in option.list_values) {
                            owner_trust = current_keylist[key].owner_trust;
                            if (option.list_values[listitem].toLowerCase() == owner_trust) {
                                selected = "selected";
                            } else {
                                selected = "";
                            }
                            compiled_option_list += "<option class=\"ui-state-default\" value=\"" + 
                                option.list_values[listitem].toLowerCase() + "\" " + 
                                selected + ">" + option.list_values[listitem] + "</option>";
                        }
                        compiled_option_list += "</select></span>";
                        break;
                }
            }
            keystatus = (current_keylist[key].disabled)? 'enable':'disable';
            keystatus_text = (current_keylist[key].disabled)? 'Enable this Key':'Disable this Key';
            key_option_button = "<span class='uid-options' style='font-size:12px;'><input class='" + 
                    type + "-key-option-button' id='" + keystatus + "-" + type + "-" + key + 
                        "' type='button' value='" + keystatus_text + "'/\></span>";
            uidlist_innerHTML = "<div class='keydetails'><span class='dh'>Key Details</span><hr/\>" +
                "<span><h4>KeyID:</h4> 0x" + key.substr(-8) + "</span><span><h4>Key Created:</h4> " + 
                    created_date + "</span><span><h4>Expires:</h4> " + expiry +
                        "</span><span><h4>UIDs:</h4> " + current_keylist[key].nuids + "</span><br/\>" +
                "<h4>Fingerpint:</h4> " + current_keylist[key].fingerprint + "<br/\>" +
                "<span><h4>Status:</h4> " + status + "</span><span><h4>Key Algorithm:</h4> " +
                        current_keylist[key].subkeys[0].algorithm_name + "</span>" +
                "<span><h4>Validity:</h4> " + current_keylist[key].uids[0].validity + "</span>" +
                "<br/\>" +
                "<span class='dh'>Key Options</span><hr/\>" +
                compiled_option_list + "<br/\>" + 
                "<span class='dh'>Operations</span><hr/\>" +
                    key_option_button + 
                "<span class='uid-options' style='font-size:12px;'><input class='" + 
                            type + "-key-option-button' id='delete-" + type + "-" + key + 
                                "' type='button' value='Delete this Key'/\></span>";
            uidlist_innerHTML += "<span class='uid-options' style='font-size:12px;'><input class='" + 
                type + "-key-option-button' id='export-" + type + "-" + key + 
                    "' type='button' value='Export this Key'/\></span><br/\>" +
                "</div>";
            uidlist.innerHTML = uidlist_innerHTML;
            subkey_info = "<span class='dh'>Subkeys</span><hr/\>";
            for (subkey in current_keylist[key].subkeys) {
                skey = current_keylist[key].subkeys[subkey];
                skey_status = "Valid";
                if (skey.disabled) {
                    skey_status = "Disabled";
                }
                if (skey.expired) {
                    skey_status = "Expired";
                }
                if (skey.invalid) {
                    skey_status = "Invalid";
                }
                if (skey.revoked) {
                    skey_status = "Revoked";
                }
                created_date = new Date(skey.created * 1000).toJSON().substring(0, 10);
                expiry = (skey.expires == 0) ? 'Never' : new Date(skey.expires * 1000).toJSON();
                if (skey.expires > 0) {
                    expiry = (Math.round(new Date().getTime()/1000.0) > skey.expires) ? "Expired" : expiry.substring(0, 10);
                }
                if (key == openKey && subkey == openSubkey) {
                    extraClass = " open_subkey";
                } else {
                    extraClass = "";
                }
                if (skey.revoked) {
                    extraClass += " invalid-key";
                }
                flags = []
                sign_flag = (skey.can_sign) ? flags.push("Sign") : "";
                enc_flag = (skey.can_encrypt) ? flags.push("Encrypt") : "";
                auth_flag = (skey.can_authenticate) ? flags.push("Authenticate") : "";
                subkey_info += "<div class=\"subkey" + extraClass + "\" id=\"" + 
                    key + '-s' + subkey + "\"><h4 class='subkeylist'><a href='#'>" +
                    "<span style='margin:0; width: 50%'>" + skey.size + 
                    key_algorithm_types[skey.algorithm_name] + "/" + skey.subkey.substr(-8) + 
                    "</span></a></h4><div class=\"subkey-info\">" +
                    "<div class='keydetails'><span class='dh'>Subkey Details</span><hr/\>" +
                    "<span><h4>KeyID:</h4> 0x" + skey.subkey.substr(-8) + "</span><span><h4>Key Created:</h4> " + 
                    created_date + "</span><span><h4>Expires:</h4> " + expiry + "</span>" +
                    "<br/\><h4>Fingerpint:</h4> " + skey.subkey + "<br/\>" +
                    "<span><h4>Status:</h4> " + skey_status + "</span><span><h4>Key Algorithm:</h4> " +
                    skey.algorithm_name + "</span><span><h4>Flags:</h4> " + flags.toString() + "</span>";
                if (type == "private") {
                    subkey_info += "<br/\>" +
                        "<span class='dh'>Key Options</span><hr/\>" +
                        "<span class='uid-options' style='font-size:12px;'><input class='" + 
                        "sub-key-option-button' id='expire-subkey-" + key + "-" + subkey + 
                        "' type='button' value='Change Expiration'/\></span>" +
                        "<br/\>" +
                        "<span class='dh'>Operations</span><hr/\>" +
                        "<span class='uid-options' style='font-size:12px;'><input class='" + 
                        "sub-key-option-button' id='delete-subkey-" + key + "-" + subkey + 
                        "' type='button' value='Delete this Subkey'/\></span>" +
                        "<span class='uid-options' style='font-size:12px;'><input class='" + 
                        "sub-key-option-button' id='revoke-subkey-" + key + "-" + subkey + 
                        "' type='button' value='Revoke this Subkey'/\></span>"
                }
                subkey_info += "</div></div></div>";
            }
            $(uidlist).append(subkey_info);
            $(uidlist).append("<br/\><span class='dh'>User IDs</span><hr/\>");
            for (uid in current_keylist[key].uids) {
                uidobj = document.createElement('div');
                uidobj.setAttribute('class', 'uid');
                uidobj.setAttribute('id', key + '-' + uid);
                if (key == openKey && uid == openUID)
                    $(uidobj).addClass('open_uid');
                if (current_keylist[key].expired || current_keylist[key].uids[uid].revoked)
                    uidobj.className += ' invalid-key';
                email = (current_keylist[key].uids[uid].email.length > 1) ? "  -  &lt;" + current_keylist[key].uids[uid].email + "&gt;" :
                    "  - (no email address provided)";
                uidobj.innerHTML += "<h4 class='uidlist'><a href='#'><span style='margin:0; width: 50%'>" + current_keylist[key].uids[uid].uid + email + "</span><span class='trust' style='text-decoration: none;'></span></a></h4>";
                signed = 0;
                nd_trust = false;
                uidobjbody = document.createElement('div');
                primary_button = "";
                revoke_button = "";

                if (type == "private") {
                    if (uid != 0) {
                        primary_button = "<span class=\"uid-options\"><input class='uid-option-button uid-option-button-primary' id='primary-" +
                            type + "-" + key + "-" + uid + "' type='button' value='Make primary'/\></span>";
                    }
                    if (!current_keylist[key].uids[uid].revoked){
                        revoke_button = "<span class=\"uid-options\"><input class='uid-option-button uid-option-button-revoke' id='revoke-" +
                            type + "-" + key + "-" + uid + "' type='button' value='Revoke UID'/\></span>";
                    }
                }

                uidobjbody.innerHTML = "<div class=\"uid-options\"><span class='uid-options'><input class='uid-option-button-sign' id='sign-" + type + "-" + key + "-" + uid + "' type='button' value='Sign this UID'/\></span>" +
                    "<span class='uid-options'>" + primary_button + revoke_button + "<input class='uid-option-button' id='delete-" + type + "-" + key + "-" + uid +
                    "' type='button' value='Delete this UID'/\></span></div>";
                uidobjbody.innerHTML += "<br/\>";
                if (current_keylist[key].uids[uid].revoked) {
                    $(uidobjbody).find('.uid-option-button-sign').addClass('uid-revoked');
                    $(uidobjbody).find('.uid-option-button-primary').addClass('uid-revoked');
                }
                if (current_keylist[key].expired)
                    $(uidobjbody).find('.uid-option-button-sign').addClass('key-expired');
                // Not all signatures are included in the step-iteration of a signature revocation, 
                //  therefor we need to keep track of the index of revocable keys.
                rev_index = -1;
                // For each signature that is revoked, there  are 2 signatures,
                //  the signature to be revoked and the revocation signature.
                //  We need to keep a list of revocation signature ID's so we can
                //  exclude the revoked signatures from being displayed.
                revocation_sig_ids = {}
                for (sig in current_keylist[key].uids[uid].signatures) {
                    sig_keyid = current_keylist[key].uids[uid].signatures[sig].keyid
                    status = "";
                    if (current_keylist[key].uids[uid].signatures[sig].revoked) {
                        revocation_sig_ids[sig_keyid] = 'revoked';
                        status = " [REVOKED]";
                    } else if (sig_keyid in revocation_sig_ids) {
                        continue;
                    }
                    if (sig_keyid in current_keylist || nd_trust) {
                        if (sig_keyid in pkeylist) {
                            signed = 1;
                            if (!current_keylist[key].uids[uid].signatures[sig].revoked) {
                                rev_index += 1;
                            }
                        }
                        email = (current_keylist[sig_keyid].uids[0].email.length > 1) ? "&lt;" +
                            current_keylist[sig_keyid].uids[0].email + 
                            "&gt;" : "(no email address provided)"
                        if (current_keylist[key].uids[uid].signatures[sig].revoked) {
                            sig_class = " sig-revoked";
                            sig_image = "stock_signature-bad.png";
                        } else if (!current_keylist[key].uids[uid].signatures[sig].expired && !current_keylist[key].uids[uid].signatures[sig].invalid) {
                            sig_class = " sig-good";
                            sig_image = "stock_signature-ok.png";
                        } else {
                            sig_class = "";
                            sig_image = "stock_signature.png";
                        }
                        sig_box = "<div id='sig-" + sig_keyid + "-" + sig + "' class='signature-box " + sig_class + "'>" +
                            "<img src='images/badges/" + sig_image + "'>" + 
                            "<div style='float:left; clear:right;width:80%;'><span class='signature-uid'>" + 
                            current_keylist[sig_keyid].name + status + "</span><br/\><span class='signature-email'>" + 
                            email + "</span><br/\><span class='signature-keyid'>" + sig_keyid + "</span><br/\>";
                        date_created = new Date(current_keylist[key].uids[uid].signatures[sig].created * 1000).toJSON();
                        date_expires = (current_keylist[key].uids[uid].signatures[sig].expires == 0) ? 
                            'Never' : new Date(current_keylist[key].uids[uid].signatures[sig].expires * 1000).toJSON().substring(0, 10);
                        sig_box += "<span class='signature-keyid'>Created: " + date_created.substring(0, 10) + "</span><br/\>";
                        sig_box += "<span class='signature-keyid'>Expires: " + date_expires + "</span><br/\>"

                        sig_box += "<span class='signature-keyid'>";
                        if (sig_keyid == key) {
                            sig_box += "[self-signature]";
                        } else if (!current_keylist[key].uids[uid].signatures[sig].exportable) {
                            sig_box += "[local, non-exportable]";
                        } else {
                            sig_box += "[other signature]";
                        }
                        sig_box += "</span></div><br/\>";

                        if (signed && current_keylist[key].uids[uid].signatures[sig].exportable && key != sig_keyid
                            && !current_keylist[key].uids[uid].signatures[sig].revoked) {
                            sig_box += "<input type='button' class='revsig-button' id='revsig-" + type + "-" + 
                                key + "-" + uid + "-" + rev_index + "' value='Revoke'/\>";
                        }
                        sig_box += "<input type='button' class='delsig-button' id='delsig-" + type + "-" + key +
                            "-" + uid + "-" + sig + "' value='Delete'/\></div>";
                        uidobjbody.innerHTML += sig_box;
                    }
                }
                uidobj.appendChild(uidobjbody);
                uidlist.appendChild(uidobj);
            }
            keyobj.appendChild(uidlist);
        }

        // This allows us to toggle the "Enable" and "Default" buttons without activating the accordion
        $('.trust').click(function(e){
            e.stopPropagation();
        });

        $('#' + type + '_keylist').children('.primary_key').accordion({ header: 'h3', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active: '.ui-accordion-left',
                    collapsible: true }).children();
        $('#' + type + '_keylist').children('.open_key').accordion("activate" , 0);

        $(".uidlist").find('.subkey').accordion({ header: 'h4.subkeylist', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active:'.ui-accordion-left',
                    collapsible: true });

        $(".uidlist").children('.uid').accordion({ header: 'h4.uidlist', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active:'.ui-accordion-left',
                    collapsible: true });

        $('.open_uid').accordion("activate", 0);
        $('.open_subkey').accordion("activate", 0);
        $('.ui-add-hover').hover(
            function(){
                $(this).addClass("ui-state-hover");
            },
            function(){
                $(this).removeClass("ui-state-hover");
            }
        );
        $('.private-key-option-list, .public-key-option-list').hover(
            function(){
                $(this).addClass("ui-state-hover");
            },
            function(){
                $(this).removeClass("ui-state-hover");
            }
        ).change(function(){
            params = this.id.split('-');
            switch(params[0]) {
                case "trust":
                    trust_value = this.options.selectedIndex + 1;
                    console.log(this.options.selectedIndex + 1)
                    result = window.ext.plugin.gpgSetKeyTrust(params[2], trust_value);
                    if (result.error) {
                        console.log(result);
                        return
                    }
                    break;
                default:
                    console.log("we don't know what to do with ourselves...");
                    alert("You attempted to activate " + params[0] +
                        ", but this is not yet implemented...");
                    break;
            }
            console.log(".*-key-option-list changed..", params, trust_value, result);
            buildKeylist(null, params[1], params[2], null, null);
        });
        $('.private-key-option-button, .public-key-option-button, .sub-key-option-button').button().click(function(e){
            params = this.id.split('-');
            refresh = false;
            switch(params[0]) {
                case "disable":
                    window.ext.plugin.gpgDisableKey(params[2]);
                    refresh = true;
                    break;

                case "enable":
                    window.ext.plugin.gpgEnableKey(params[2]);
                    refresh = true;
                    break;

                case "expire":
                    $( "#keyexp-dialog" ).dialog({
			            resizable: true,
			            height: 190,
			            modal: true,
                        open: function(event, ui) {
                            key = window.ext.plugin.getNamedKey(params[2])
                            $("#keyexp-date-input").datepicker({
                                minDate: "+1D",
                                maxDate: "+4096D",
                                changeMonth: true,
		                        changeYear: true
                            });
                            if (params.length > 3) {
                                subkey_idx = params[3];
                            } else {
                                subkey_idx = 0;
                            }
                            if (key[params[2]].subkeys[subkey_idx].expires == 0) {
                                $("#keyexp-never")[0].checked = true;
                                $("#keyexp-date-input").hide();
                            } else {
                                $("#keyexp-ondate")[0].checked = true;
                                $("#keyexp-date-input").show();
                                $('#keyexp-buttonset').children().blur();
                                $("#keyexp-dialog").dialog({ height: 390 })
                            }
                            $("#keyexp-buttonset").buttonset();
                            $("#keyexp-ondate").change(function(){
                                $("#keyexp-date-input").show();
                                $("#keyexp-dialog").dialog({ height: 390 })
                            })
                            $("#keyexp-never").change(function(){
                                $("#keyexp-date-input").hide();
                                $("#keyexp-dialog").dialog({ height: 190 })
                            })

                        },
                        close: function(event,ui) {
                            console.log("destroyed...");
                            $("#keyexp-date-input").datepicker('destroy');
                            $(this).dialog('destroy');
                        },
			            buttons: {
				            "Save": function() {
                                if ($("#keyexp-never")[0].checked) {
                                    new_expire = 0;
                                } else {
                                    expire = $("#keyexp-date-input").datepicker("getDate");
                                    expiration = new Date();
                                    expiration.setTime(expire);
                                    today = new Date();
                                    today.setHours("0");
                                    today.setMinutes("0");
                                    today.setSeconds("1");
                                    today.setDate(today.getDate()+2);
                                    console.log(today);
                                    one_day = 1000*60*60*24;
                                    new_expire = Math.ceil((expiration.getTime()-today.getTime())/(one_day) + 0.5);
                                    if (new_expire < 1)
                                        new_expire = 1;
                                    console.log(new_expire);
                                }
                                // set to new expiration here;
                                if (subkey_idx) {
                                    window.ext.plugin.gpgSetSubkeyExpire(params[2], subkey_idx, new_expire);
                                } else {
                                    window.ext.plugin.gpgSetPubkeyExpire(params[2], new_expire);
                                }
                                $(this).dialog("close");
                                if (params[1] == "subkey") {
                                    params[1] = "private";
                                }
                                $(this).dialog("close");
                                buildKeylist(null, params[1], params[2], params[3], null);
				            },
				            "Cancel": function() {
					            $(this).dialog("close");
				            }
			            }
		            });
                    console.log("we should set the expiration here...", params);
                    break;

                case "passphrase":
                    console.log(window.ext.plugin.gpgChangePassphrase(params[2]));
                    refresh = false;
                    break;

                case "delete":
                    console.log(params);
                    $( "#delete-key-dialog-confirm" ).dialog({
			            resizable: true,
			            height:160,
			            modal: true,
			            buttons: {
				            "Delete this key": function() {
                                // Delete the Public Key
                                if (params[1] == "public") {
                                    result = window.ext.plugin.gpgDeletePublicKey(params[2]);
                                }
                                if (params[1] == "private") {
                                    result = window.ext.plugin.gpgDeletePrivateKey(params[2]);
                                }
                                if (params[1] == "subkey") {
                                    result = window.ext.plugin.gpgDeletePrivateSubKey(params[2],
                                        parseInt(params[3]));
                                }
					            $( this ).dialog( "close" );

                                if (result && !result.error) {
                                    if (params[1] == "subkey") {
                                        // Override the keylist type param
                                        params[1] = "private";
                                    } else {
                                        // Remove the Key-ID from the params array, since it
                                        //  no longer exists
                                        params[2] = null;
                                    }
                                    buildKeylist(null, params[1], params[2], null, null);
                                }
				            },
				            Cancel: function() {
					            $( this ).dialog( "close" );
				            }
			            }
		            });
		            break;

		        case "adduid":
                    $("#adduid-dialog").dialog({
			            resizable: true,
			            height: 230,
			            width: 550,
			            modal: true,
                        "buttons": { 
                            "Create": function() {
                                form = $(this).find("#adduid-form")[0];
                                if (!$("#adduid-status").length) {
                                    $(form).parent().before("<div id=\"adduid-status\"> </div>");
                                }
                                error = "";
                                if (!form.uid_0_name.value){
                                    error += "Name Required<br>";
                                    $(form.uid_0_name).addClass("ui-state-error");
                                }
                                if (form.uid_0_name.value.length < 5){
                                    error += "UID Names must be at least 5 characters long<br>";
                                    $(form.uid_0_name).addClass("ui-state-error");
                                }
                                if (!isNaN(form.uid_0_name.value[0])){
                                    error += "UID Names cannot begin with a number<br>";
                                    $(form.uid_0_name).addClass("ui-state-error");
                                }
                                if (form.uid_0_email.value && !isValidEmailAddress(form.uid_0_email.value)){
                                    error += "Not a valid email address<br>";
                                    $(form.uid_0_email).addClass("ui-state-error");
                                } else {
                                    $(form.uid_0_email).removeClass("ui-state-error");
                                }
                                if (error.length) {
                                    $("#adduid-status").html(error)[0].style.display="block";
                                    return false;
                                }
                                window.adduid_waiting = true;
                                $("#adduid-dialog").dialog("option", "minHeight", 250);
                                $("#adduid-status").html(error)[0].style.display="block";
                                result = window.ext.plugin.gpgAddUID(params[2], form.uid_0_name.value,
                                        form.uid_0_email.value, form.uid_0_comment.value);
                                if (result.error) {
                                    console.log(result);
                                    return
                                }
                                $(this).dialog("close");
                                $("#adduid-form")[0].reset();
                                $("#adduid-dialog").dialog("destroy");
                                buildKeylist(null, params[1], params[2], null, null);
                            },
                            Cancel: function() {
                                $("#adduid-dialog").dialog("close");
                                $("#adduid-form")[0].reset();
                                $("#adduid-dialog").dialog("destroy");
                            }
                        },
                    });
                    break;

                case "addsubkey":
                    window.genkey_refresh = false;
                    $("#gensubkey-dialog").dialog({
                        resizable: true,
                        minHeight: 300,
                        width: 300,
                        modal: true,
                        autoOpen: false,
                        "buttons": { 
                            "Create": function() {
                                form = $(this).find("#gensubkey-form")[0];
                                form.key_id.value = params[2];
                                $(form).parent().before("<div id=\"gensubkey-status\"> </div>");
                                error = "";
                                window.genkey_waiting = true;
                                chrome.extension.onConnect.addListener(function(port) {
                                    port.onMessage.addListener(function(msg) {
                                        if (msg.type == "progress") {
                                            console.log(msg.data);
                                            data = msg.data;
                                            if (!isNaN(data))
                                                data = String.fromCharCode(data);
                                            data += " ";
                                            if($("#gensubkey_progress"))
                                                $("#gensubkey_progress")[0].innerHTML += data;
                                            if(data == "complete" || data == "complete ") {
                                                window.genkey_refresh = true;
                                                window.genkey_waiting = false;
                                                new_pkeylist = window.ext.plugin.getPrivateKeyList();
                                                generated_key = null;
                                                for (key in new_pkeylist) {
                                                    if (key in window.pkeylist == false) {
                                                        generated_key = key;
                                                        break;
                                                    }
                                                }
                                                subkey_index = 0;
                                                if (ext.secret_keys.hasOwnProperty(params[2])) {
                                                    for (subkey in ext.secret_keys[params[2]].subkeys) {
                                                        subkey_index = parseInt(subkey) + 1;
                                                    }
                                                }
                                                buildKeylist(null, "private", params[2], subkey_index, null);
                                                $("#gensubkey-status_detail").remove()
                                                $("#gensubkey-status").remove();
                                                $("#gensubkey-form")[0].reset();
                                                $("#gensubkey-form")[0].style.display="inline-block";
                                                $("#gensubkey-dialog").dialog("close");
                                            }
                                        }
                                    });
                                });
                                $("#gensubkey-form").find(".open").trigger("click");
                                console.log("going to create a subkey with the following details:" + '\n' +
                                    "Key ID:", form.key_id.value, " Sub Key:", form.subKey_algo.value + 
                                      ' (' + form.subKey_size.value + ')\n' + " sign_flag: " + form.sign.checked +
                                      " enc_flag: " + form.enc.checked + " auth_flag: " + form.auth.checked + "\n" +
                                    "expiration: Key will expire in " + form.key_expire.value + ' days');
                                $("#gensubkey-dialog").dialog("option", "minHeight", 300);
                                $("#gensubkey-status").html(error)[0].style.display="block";
                                $("#gensubkey-status").html("Building key, please wait..");
                                $("#gensubkey-status").after("<div id='gensubkey-status_detail' style=\"font-size: 12px; color:#fff;padding: 20px;\">This may take a long time (5 minutes or more) to complete depending on the selected options. Please be patient while the key is created. It is safe to close this window, key generation will continue in the background.<br><br><div id='gensubkey_progress' style='height:auto;display:block;'></div></div>");
                                $(form)[0].style.display = 'none';
                                $("#gensubkey-dialog")[0].style.height = "20";
                                $("#gensubkey-dialog")[0].style.display = "none";
                                response = ext.plugin.gpgGenSubKey(form.key_id.value,
                                    form.subKey_algo.value,
                                    form.subKey_size.value,
                                    form.key_expire.value,
                                    (form.sign.checked) ? 1 : 0,
                                    (form.enc.checked) ? 1 : 0,
                                    (form.auth.checked) ? 1 : 0
                                );
                                if (response == "queued") {
                                    $("#gensubkey-dialog").dialog("option", "buttons", { 
                                        "Close": function() {
                                            $("#gensubkey-dialog").dialog("close");
                                        }
                                    });
                                }
                            },
                            Cancel: function() {
                                $("#gensubkey-dialog").dialog("close");
                                if (window.gensubkey_refresh)
                                    buildKeylist(null, 'private');
                            }
                        },
                    });
                    $("#subKey_flags").buttonset();
                    $("#gensubkey-form").children('input').removeClass('input-error');
                    $("#gensubkey-form")[0].reset();
                    $('#gensubkey-form .subkey-algo').each(function(){
                        $(this)[0].options.selectedIndex = $(this)[0].options.length - 1;
                        $(this).parent().find('.key-size')[0].children(0).disabled = true;
                        $($(this).parent().find('.key-size')[0].children(0)).hide();
                    }).change(function(){
                        selectedIndex = $(this)[0].options.selectedIndex;
                        if (selectedIndex == 0 || selectedIndex == 4) {
                            // DSA Selected
                            $(this).parent().find('.key-size')[0].children(0).disabled = false;
                            $($(this).parent().find('.key-size')[0].children(0)).show();
                            $(this).parent().find('.key-size')[0].children(4).disabled = true;
                            $($(this).parent().find('.key-size')[0].children(4)).hide();
                        } else if (selectedIndex == 1 || selectedIndex == 3 || selectedIndex == 5) {
                            // RSA Selected
                            $(this).parent().find('.key-size')[0].children(0).disabled = true;
                            $($(this).parent().find('.key-size')[0].children(0)).hide();
                            $(this).parent().find('.key-size')[0].children(4).disabled = false;
                            $($(this).parent().find('.key-size')[0].children(4)).show();
                        } else if (selectedIndex == 2) {
                            // ElGamal Selected
                            $(this).parent().find('.key-size')[0].children(0).disabled = false;
                            $($(this).parent().find('.key-size')[0].children(0)).show();
                            $(this).parent().find('.key-size')[0].children(4).disabled = false;
                            $($(this).parent().find('.key-size')[0].children(4)).show();
                        }
                        if (selectedIndex < 4) {
                            $("#subKey_flags").hide();
                            $("#gensubkey-dialog").dialog("option", "height", 240);
                        } else {
                            if (selectedIndex == 4) {
                                $("#subKey_flags").find('#sign')[0].checked = true;
                                $("#subKey_flags").find('#enc')[0].checked = false;
                                $("#subKey_flags").find('#auth')[0].checked = false;
                                $("#subKey_flags").find('#enc')[0].disabled = true;
                            } else {
                                $("#subKey_flags").find('#sign')[0].checked = true;
                                $("#subKey_flags").find('#enc')[0].checked = true;
                                $("#subKey_flags").find('#auth')[0].checked = false;
                                $("#subKey_flags").find('#enc')[0].disabled = false;
                            }
                            $("#subKey_flags").show();
                            $("#gensubkey-dialog").dialog("option", "height", 300);
                        }
                        $("#subKey_flags").buttonset("refresh");
                    });
                    $("#gensubkey-dialog").dialog('open');
                    $("#gensubkey-form").find(".open").trigger("click");
                    break;

                case "export":
                    export_result = window.ext.plugin.gpgExportPublicKey(params[2]).result;
                    $("#export-dialog-text")[0].innerHTML = export_result;
                    $("#export-dialog-copytext")[0].innerHTML = export_result;
                    $("#export-dialog").dialog({
			            resizable: true,
			            height: 230,
			            width: 426,
			            modal: true,
                        "buttons": {
                            "Copy": function() {
                                $("#export-dialog-copytext")[0].select();
                                if (document.execCommand("Copy")) {
                                    $("#export-dialog-msg")[0].innerHTML = "Copied!";
                                } else {
                                    $("#export-dialog-msg")[0].innerHTML = "There may have been a problem placing the data into the clipboard";
                                }
                                $("#export-dialog-msg")[0].style.display="block"
                            },
                            "Close": function() {
                                $("#export-dialog").dialog("destroy");
                                $("#export-dialog-msg")[0].style.display="none"
                            }
                        }
                    })
                    break;

                case "revoke":
                    options = "Please specify the revocation details -<br/\><br/\>" +
                        "<label for='revkey-reason'>Reason:</label>" +
                        "<select name='revkey-reason' id='revkey-reason' class='ui-add-hover ui-corner-all ui-widget ui-state-default'>" +
                        "<option value='0' class='ui-state-default'>No reason specified</option>" +
                        "<option value='1' class='ui-state-default'>Key has been compromised</option>" +
                        "<option value='2' class='ui-state-default'>Key is superseded</option>" +
                        "<option value='2' class='ui-state-default'>Key is no longer used</option>" +
                        "</select><br/\>" +
                        "<label for='revkey-desc'>Description:</label>" +
                        "<input type='text' name='revkey-desc' id='revkey-desc' class='ui-corner-all ui-widget ui-state-default'/\>";
                    $("#revkey-confirm").find('#revkey-text')[0].innerHTML = options
                    $("#revkey-confirm").dialog({
                        resizable: true,
                        height:250,
                        width: 350,
                        modal: true,
                        autoOpen: false,
                        "buttons": {
                            "Revoke": function() {
                                reason = $('#revkey-reason')[0].value;
                                desc = $('#revkey-desc')[0].value;
                                console.log(params[2], params[3], reason, desc);
                                revkey_result = window.ext.plugin.gpgRevokeKey(params[2],
                                    parseInt(params[3]), parseInt(reason), desc);
                                buildKeylist(null, "private", params[2], params[3], null);
                                $("#revkey-confirm").dialog("close");
                            },
                            "Cancel": function() {
                                $("#revkey-confirm").dialog("close");
                            }
                        }
                    });
                    $("#revkey-confirm").dialog('open');
                    break;

                default:
                    console.log("we don't know what to do with ourselves...");
                    alert("You attempted to activate " + params[0] +
                        ", but this is not yet implemented...");
                    break;
            }
            console.log(".*-key-option-button pressed..", params);
            if (refresh) {
                if (params[1] == "subkey")
                    params[1] = "private";
                buildKeylist(null, params[1], params[2], null, null);
            }
        });
        $('.uid-option-button').button().click(function(e){
            params = this.id.split('-');
            refresh = false;
            switch(params[0]) {
                case "delete":
                    $( "#deluid-confirm" ).dialog({
			            resizable: true,
			            height:160,
			            modal: true,
			            buttons: {
				            "Delete this UID": function() {
                                // Delete the Public Key
                                uid_idx = parseInt(params[3]) + 1;
                                result = window.ext.plugin.gpgDeleteUID(params[2], uid_idx);
                                console.log(result, params[2], uid_idx);
					            $( this ).dialog( "close" );
                                // Remove the Key-ID from the params array, since it
                                //  no longer exists
                                if (!result.error) {
                                    params[3] = null;
                                    buildKeylist(null, params[1], params[2], null, null);
                                }
				            },
				            Cancel: function() {
					            $( this ).dialog( "close" );
				            }
			            }
		            });
                    break;

                case "primary":
                    refresh = true;
                    uid_idx = parseInt(params[3]) + 1;
                    result = window.ext.plugin.gpgSetPrimaryUID(params[2], uid_idx);
                    params[3] = 0;
                    break;

                case "revoke":
                    options = "Please specify the revocation details -<br/\><br/\>" +
                        "<label for='revuid-reason'>Reason:</label>" +
                        "<select name='revuid-reason' id='revuid-reason' class='ui-add-hover ui-corner-all ui-widget ui-state-default'>" +
                        "<option value='0' class='ui-state-default'>No reason specified</option>" +
                        "<option value='4' class='ui-state-default'>User ID is no longer valid</option>" +
                        "</select><br/\>" +
                        "<label for='revuid-desc'>Description:</label>" +
                        "<input type='text' name='revuid-desc' id='revuid-desc' class='ui-corner-all ui-widget ui-state-default'/\>";
                    $("#revuid-confirm").find('#revuid-text')[0].innerHTML = options
                    $("#revuid-confirm").dialog({
                        resizable: true,
                        height:250,
                        width: 350,
                        modal: true,
                        autoOpen: false,
                        "buttons": {
                            "Revoke": function() {
                                reason = $('#revuid-reason')[0].value;
                                desc = $('#revuid-desc')[0].value;
                                console.log(params[2], params[3], params[4], reason, desc);
                                revuid_result = window.ext.plugin.gpgRevokeUID(params[2],
                                    parseInt(params[3]) + 1, parseInt(reason), desc);
                                buildKeylist(null, params[1], params[2], null, params[3]);
                                $("#revuid-confirm").dialog("close");
                            },
                            "Cancel": function() {
                                $("#revuid-confirm").dialog("close");
                            }
                        }
                    });
                    $("#revuid-confirm").dialog('open');
                    break;

                default:
                    console.log("we don't know what to do with ourselves...");
                    alert("You attempted to activate " + params[0] +
                        ", but this is not yet implemented...");
                    break;
            }
            console.log(".uid-option-button clicked..", params);
            if (refresh) {
                buildKeylist(null, params[1], params[2], null, params[3]);
            }
        });
        $('.uid-option-button-sign').button().click(function(e){
            $("#createsig-dialog").dialog({
                resizable: true,
                minHeight: 250,
                width: 630,
                modal: true,
                autoOpen: false
            });
            params = this.id.split('-');
            enabled_keys = window.ext.webpg_prefs.enabled_keys.get();
            $('#createsig-form')[0].innerHTML = "<p class='help-text'>Please select which of your keys to create the signature with:</p>";
            current_signatures = keylist[params[2]].uids[params[3]].signatures;
            cursig = [];
            for (sig in current_signatures) {
                cursig.push(current_signatures[sig]);
            }
            console.log(cursig)
            if (!window.ext.webpg_prefs.enabled_keys.length()) {
                $('#createsig-form')[0].innerHTML += "You have not enabled any keys for use with webpg; <a href='" + chrome.extension.getURL('key_manager.html') + "?tab=0&helper=enable'>please click here</a> and select 1 or more keys for use with webpg.";
            }
            for (idx in enabled_keys) {
                key = enabled_keys[idx];
                signed = (cursig.indexOf(key) != -1);
                status = signed? "<div style='width: 28px; display: inline;text-align:right;'><img style='height: 14px; padding: 2px 2px 0 4px;' id='img_" + key + "' " +
                    "src='/images/badges/stock_signature.png' alt='Already signed with this key'/\></div>" :
                    "<div style='width: 28px; display: inline;text-align:right;'><img style='display:none; height: 14px; padding: 2px 2px 0 4px;' id='img_" + key + "' " +
                    "src='/images/check.png' alt='Signature added using this key'/\></div>";
                if (signed)
                    status += "<input style='display: none;' type='checkbox' id='sign_" + key + "' name='" + key + "' disabled/\>";
                else
                    status += "<input type='checkbox' id='sign_" + key + "' name='" + key + "'/\>";
<!--                console.log(key);-->
                $('#createsig-form')[0].innerHTML += status + "<label for='sign_" + key + "' id='lbl-sign_" + key + "' class='help-text'>" + pkeylist[key].name + " (" + key + ")</label><div id='lbl-sign-err_" + key + "' style='display: none;'></div><br/\>";
                if (window.ext.webpg_prefs.enabled_keys.length() == 1 && signed) {
                    $($("button", $("#createsig-dialog").parent()).children()[1]).hide();
                }
            }
            var refresh = false;
            $("#createsig-dialog").dialog({
                "buttons": {
                    "Cancel": function() {
                        $("#createsig-dialog").dialog("destroy");
                        if (refresh) {
                            buildKeylist(null, params[1], params[2], null, params[3]);
                        }
                    },
                    " Sign ": function() {
                        checked = $("#createsig-form").children("input:checked");
                        error = false;
                        for (item in checked) {
                            if (checked[item].type == "checkbox") {
                                sign_result = window.ext.plugin.gpgSignUID(params[2], 
                                    parseInt(params[3]) + 1,
                                    checked[item].name, 1, 1, 1);
                                error = (error || (sign_result['error'] && sign_result['gpg_error_code'] != 65)); // if this is true, there were errors, leave the dialog open
                                if (sign_result['error'] && sign_result['gpg_error_code'] != 65) {
                                    $('#img_' + checked[item].name)[0].src = "/images/cancel.png"
                                    lbl_sign_error = $('#lbl-sign-err_' + checked[item].name)[0];
                                    lbl_sign_error.style.display = "inline";
                                    lbl_sign_error.style.color = "#f40";
                                    lbl_sign_error.style.margin = "0 0 0 20px";
                                    lbl_sign_error.innerHTML = sign_result['error_string'];
                                    $($("button", $("#createsig-dialog").parent()).children()[0]).text("Close")
                                    $($("button", $("#createsig-dialog").parent()).children()[1]).text("Try again")
                                } else {
                                    refresh = true; // the keys have changed, we should refresh on dialog close;
                                    $('#img_' + checked[item].name)[0].src = "/images/check.png"
                                }
                                $('#img_' + checked[item].name).show().next().hide();
                            }
                        }
                        console.log("should we refresh?", refresh? "yes":"no");
                        if (!error && refresh) {
                            $("#createsig-dialog").dialog("destroy");
                            buildKeylist(null, params[1], params[2], null, params[3]);
                        }
                    }
                }
            })
            if (window.ext.webpg_prefs.enabled_keys.length() == 1 && cursig.indexOf(enabled_keys[0]) != -1) {
                $($("button", $("#createsig-dialog").parent()).children()[1]).hide();
            }
            $("#createsig-dialog").dialog('open');
        });
        if (!window.ext.plugin.gpg_status.gpgconf_detected) {
            $('.uid-option-button-sign').button({disabled: true, label: "Cannot create signatures without gpgconf utility installed"});
        }
        $('.uid-option-button-sign.uid-revoked').button({disabled: true, label: "Cannot sign a revoked UID"});
        $('.uid-option-button-primary.uid-revoked').button({disabled: true, label: "Cannot make a revoked UID primary"});
        $('.uid-option-button-sign.key-expired').button({disabled: true, label: "Cannot sign an expired key"});
        $('.revsig-button').button().click(function(e){
            params = this.id.split('-');
            calling_button = this;
            sig_details = $(calling_button).parent()[0].id.split('-');
            options = "Please specify the revocation details -<br/\><br/\>" +
                "<label for='revsig-reason'>Reason:</label>" +
                "<select name='revsig-reason' id='revsig-reason' class='ui-add-hover ui-corner-all ui-widget ui-state-default'>" +
                "<option value='0' class='ui-state-default'>No reason specified</option>" +
                "<option value='4' class='ui-state-default'>User ID is no longer valid</option>" +
                "</select><br/\>" +
                "<label for='revsig-desc'>Description:</label>" +
                "<input type='text' name='revsig-desc' id='revsig-desc' class='ui-corner-all ui-widget ui-state-default'/\>";
            $("#revsig-confirm").find('#revsig-text')[0].innerHTML = options
            $("#revsig-confirm").dialog("option",
                "buttons", {
                    "Revoke": function() {
                        reason = $('#revsig-reason')[0].value;
                        desc = $('#revsig-desc')[0].value;
                        console.log(params[2], params[3], params[4], reason, desc);
                        revsig_result = window.ext.plugin.gpgRevokeSignature(params[2],
                            parseInt(params[3]), parseInt(params[4]), parseInt(reason), desc);
                        //console.log('delete', delsig_result, params[2], parseInt(params[3]) + 1, parseInt(params[4]) + 1)
                        buildKeylist(null, params[1], params[2], null, params[3]);
                        $("#revsig-confirm").dialog("close");
                    },
                    "Cancel": function() {
                        $("#revsig-confirm").dialog("close");
                    }
                }
            );
            $("#revsig-confirm").dialog('open');
        });
        $("#revsig-confirm").dialog({
            resizable: true,
            height:250,
            width: 350,
            modal: true,
            autoOpen: false,
            buttons: {
                'Revoke this Signature?': function() {
                    $(this).dialog('close');
                },
                Cancel: function() {
                    $(this).dialog('close');
                }
            }
        });

        $('.delsig-button').button().click(function(e){
            params = this.id.split('-');
            calling_button = this;
            sig_details = $(calling_button).parent()[0].id.split('-');
            $("#delsig-confirm").find('#delsig-text')[0].innerHTML = "Are you certain you would like to delete signature " +
                sig_details[1] + " from this User id?";
            if (sig_details[1] in pkeylist < 1) {
                $("#delsig-confirm").find('#delsig-text')[0].innerHTML += "<br><br><span class='ui-icon ui-icon-alert' style='float:left; margin:0 7px 20px 0;'></span>This signature was made with a key that does not belong to you; This action cannot be undone without refreshing the keylist from a remote source.";
                $("#delsig-confirm").dialog("option", "height", "200");
            }
            $("#delsig-confirm").dialog("option", "buttons", { "Delete": function() {
                        delsig_result = window.ext.plugin.gpgDeleteUIDSign(params[2], parseInt(params[3]) + 1, parseInt(params[4]) + 1);
                        console.log('delete', delsig_result, params[2], parseInt(params[3]) + 1, parseInt(params[4]) + 1)
                        //$(calling_button).parent().parent()[0].removeChild($(calling_button).parent()[0]);
                        buildKeylist(null, params[1], params[2], null, params[3]);
                        $("#delsig-confirm").dialog("close");
                    },
                    Cancel: function() {
                        $("#delsig-confirm").dialog("close");
                    }
                }
            );
            $("#delsig-confirm").dialog('open');
        });
        $("#delsig-confirm").dialog({
            resizable: true,
            height:180,
            modal: true,
            autoOpen: false,
            buttons: {
                'Delete this Signature?': function() {
                    $(this).dialog('close');
                },
                Cancel: function() {
                    $(this).dialog('close');
                }
            }
        });

        $('.enable-check').button().next().next().button({
                text: false,
                icons: {
                    primary: 'ui-icon-check'
                }
        }).click(function(e) {
            keyid = this.id.substr(-16);
            window.ext.webpg_prefs.default_key.set(keyid);
            enable_element = $('#check-' + this.id.substr(-16))[0];
            enabled_keys = window.ext.webpg_prefs.enabled_keys.get();
            if (enabled_keys.indexOf(keyid) == -1) {
                window.ext.webpg_prefs.enabled_keys.add(keyid);
                $(enable_element).trigger('click');
                $(enable_element).next()[0].innerHTML = $(enable_element).next()[0].innerHTML.replace('Disabled', 'Enabled');
            }
        }).parent().buttonset();

        $('.enable-check').next().hover(
            function(e){
                $(this).parent().children('.keyoption-help-text')[0].innerHTML = "Enable this key for signing";
            },
            function(e){
                $(this).parent().children('.keyoption-help-text')[0].innerHTML = "";
            }
        );
        $('input.default-check').next().hover(
            function(e){
                $(this).parent().children('.keyoption-help-text')[0].innerHTML = "Make this the default key for encryption operations";
            },
            function(e){
                $(this).parent().children('.keyoption-help-text')[0].innerHTML = "";
            }
        );
    }
    /* end publickeylist */


    if (window.location.search.substring) {
        var query_string = {};
        window.location.search.replace(
            new RegExp("([^?=&]+)(=([^&]*))?", "g"),
            function($0, $1, $2, $3) { query_string[$1] = $3; }
        );
    }

    selected_tab = query_string.tab ? query_string.tab : 0;
    openKey = (query_string.openkey)? query_string.openkey : null;
    if (openKey) {
        if (openKey in ext.secret_keys){
            selected_tab = 0;
        } else {
            selected_tab = 1;
        }
    }
    openSubkey = (query_string.opensubkey)? query_string.opensubkey : null;
    $('#tabs').tabs({ selected: selected_tab });
    if (selected_tab == 0)
        buildKeylist(null, 'private', openKey, openSubkey);
    if (selected_tab == 1)
        buildKeylist(null, 'public', openKey, openSubkey);
    if (query_string.strip) {
        $("#header").remove();
        $(document.getElementsByTagName("ul")[0]).remove();
    }
    $('#close').button().click(function(e) { window.close(); });
    if (query_string.helper) {
        function bounce(elem_class, left, top, perpetual) {
            nleft = $(elem_class).parent().offset().left - left;
            ntop = $(elem_class).parent().offset().top - top;
            $("#error_help").parent().css('left', nleft).css('top', ntop).
                effect("bounce", {times: 1, direction: 'up', distance: 8 }, 1200, function(){ if (perpetual) { bounce(elem_class, left, top, perpetual) } } )
        }
        helper_arrow = document.createElement('div');
        helper_arrow.innerHTML = '' +
            '<div id="error_help" style="text-align: center; display: inline; text-shadow: #000 1px 1px 1px; color: #fff; font-size: 12px;">' +
            '<div id="help_text" style="display: block; -moz-border-radius: 4px; -webkit-border-radius: 4px; z-index: 10; padding: 8px 5px 8px 5px; margin-right: -5px; background-color: #ff6600; min-width: 130px;"></div>' +
            '<span style="margin-left: 94px;"><img width="30px" src="/images/help_arrow.png"></span>' +
            '</div>';
        helper_arrow.style.position = 'absolute';
        helper_arrow.style.zIndex = 1000;
        $(helper_arrow).css("max-width", "75%");
        switch(query_string.helper){
            case 'enable':
                $(helper_arrow).find('#help_text')[0].innerHTML = "Click to enable key";
                document.body.appendChild(helper_arrow);
                $('.enable-check').click(function() { $(helper_arrow).stop(true, true).stop(true, true).hide(); });
                bounce('.enable-check', 75, 45, true);
                break;
            case 'default':
                $(helper_arrow).find('#help_text')[0].innerHTML = "Click to set default key";
                $('.default-check').click(function() { $(helper_arrow).stop(true, true).stop(true, true).hide(); });
                document.body.appendChild(helper_arrow);
                bounce('.default-check', 40, 45, true);
                break;
            case 'signuids':
                $(helper_arrow).find('#help_text')[0].innerHTML = "Below is a list of key IDs that represent the domains that this server key is valid for; please sign the domain IDs that you want to use with webpg.";
                document.body.appendChild(helper_arrow);
                bounce('#disable-public-' + openKey, 15, 15, false);
                break;
        }
    }

    $('ul.expand').each(function(){
        $('li.trigger', this).filter(':first').addClass('top').end().filter(':not(.open)').next().hide();
        $('li.trigger', this).click(function(){
            height = ($("#genkey-status")) ? $("#genkey-status").height() : 0;
            if($(this).hasClass('open')) {
                $(this).removeClass('open').next().slideUp();
                $("#genkey-dialog").dialog("option", "minHeight", 300 + height);
            } else {
                $(this).parent().find('li.trigger').removeClass('open').next().filter(':visible').slideUp();
                $(this).addClass('open').next().slideDown();
                $("#genkey-dialog").dialog("option", "minHeight", 460 + height);
            }
        });
    });

});
/* ]]> */
</script>
<style>
body{
    font: 62.5% "Trebuchet MS", sans-serif;
    min-width: 640px;
    margin: 0;
}
.ui-tabs .ui-tabs-hide {
     display: none;
}
.ui-datepicker {
 z-index: 9999 !important;
}
#tabs {
    margin: none;
}
#header-image {
    height: 48px;
    display: none;
    width: 48px;
    padding-right: 6px;
}
#trust-header {
    font-size: 16px;
    text-align: left;
    float:left;
    clear: right;
    color:black;
    text-shadow:#999 1px 1px 1px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
}
#trust-list .selected {
  color:black !important;
  font-weight:bold;
}
#trust-list {

}
#trust-list .level {
    padding:5px;
    color:gray;
}
#trust-list .level:hover {
    font-weight:bold;
}
#trust-level-desc {
    color: #000;
    text-align: left;
    display: none;
}
.trust-level-desc {
    min-height: 30px;
    border:1px solid #ddd;
    font-family:sans-serif;
    color:white;
    padding:10px;
    text-shadow:#999 1px 1px 1px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    background: #0078a3  url('images/menumask.png') repeat-x;
    width: 600px;
}
.trust-level-desc:hover {
    background-color: #1C1;
}
#trust-level-desc .selected {
    background-color: #F58400;
}
#trust-level-desc .selected .trust-level {
    color:#000;
    text-shadow:#FFE 1px 1px 1px;
}
.trust-level {
    font-size:32px;
    padding-right: 6px;
    float:left;
}
.trust-desc {
    clear:right;
}
.invalid-key .ui-accordion-header, .disabled .ui-accordion-header {
    text-decoration: line-through;
    color: #E31;
}
.uidlist, .subkeylist {
    padding-right: 20px;
}
.uid, .subkey {
    width: 100%;
}
div.uid-options {
    background-color: #eee;
    border-radius: 6px 6px 0 0;
    box-shadow: 1px 1px 10px #888;
}
.private-key-option-list, .public-key-option-list {
    padding: 2px;
}
.trust {
    right: 0;
    float: right;
    position: relative;
    text-decoration: none;
    clear: right;
}
.keydetails {
    font-size: 14px;
    font-weight: bold;
    width: 100%;
    border: solid 1px #181;
    padding: 4px 0 4px 8px;
    margin: 2px 2px 12px -2px;
    background: #0078a3  url('images/menumask.png') repeat-x;
    text-align: left;
    color: #ffffff;
    overflow-x: hidden;
}
.invalid-key .keydetails, .disabled .keydetails, .sig-revoked {
    background-color: #F31;
    border: solid 1px #F11;
}
.keydetails .dh {
    color: #000;
    font-size: 14px;
}
.keydetails hr {
    margin: 0;
    right: 0;
    margin-left: 100px;
    position:relative;
    top:-10px;
    padding:0;
}
.keydetails h4 {
    color: #fff;
    margin: 0;
    display: inline;
    text-shadow: #000 1px 1px 1px;
}
.keydetails span {
    margin-right: 16px;
    padding-right: 8px;
}
.keydetails span.ui-button-text {
    font-size: 12px;
    text-align: center;
    margin-right: 0;
}
span.trust .ui-button-text {
    padding: 4px;
    text-align: left;
    margin: 0;
    width: 50px;
    font-size: 12px;
    z-index: 800;
}
.default-check .ui-button-icon-primary{
    margin-left: 0;

}
.signature-box {
    color: #000;
    font-family:sans-serif;
    margin-top: 5px;
    background: #fff;
    min-width: 240px;
    font-size: 10px;
    display:inline-block;
    padding:8px;
    margin-right: 20px;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    -moz-box-shadow:#666 2px 2px 2px;
    -webkit-box-shadow:#666 2px 2px 2px;
}
.sign-revoked {
    background: #f8f;
}
.signature-box img {
    margin-top: 20px;
    float:left;
    height: 32px;
}
.signature-box input {
    float: right;
    position: relative;
    bottom: 0;
}
.signature-uid, .signature-email, .signature-keyid {
    font-size: 120%;
    margin-left: 10px;
    clear: both;
}
.signature-keyid {

}
.help-text {
    padding: 0 0 0 12px;
    font-size: 12px;
}
#genkey-form input[type=text], input[type=password] {
    width: 250px;
}
#genkey-status, #gensubkey-status, #adduid-status, #export-dialog-msg {
    padding: 2px 0 2px 12px;
    display:none;
    width: 98.2%;
    background-color: #FFAF0F;
    color: #000;
}
.input-error {
    border: 2px solid #f20;
}
ul.expand { padding:0; margin:0; list-style:none; }
ul.expand li { padding:0; margin:0; }
ul.expand li.trigger.top { margin-top:0; }
ul.expand li.trigger
{
    background:url(images/expand-collapse.gif) 0 3px no-repeat;
    cursor:pointer;
    padding:0 0 0 15px;
    margin:7px 0 0 0;
}
ul.expand li.trigger h4
{
    color:#666;
}
ul.expand li.trigger.open h4
{
    color:inherit;
}
ul.expand li.trigger.open
{
    background-position:0 -997px;
}
ul.expand ul
{
    list-style:disc inside;
    line-height:18px;
    padding:0 0 6px 10px;
}
.option ul {
    padding: 0;
    list-style: none;
}
.ui-add-hover, .ui-add-hover option {
    cursor:pointer;
}
.ui-datepicker-calendar th {
    color: #fff;
}
</style>
</head>
<body>
<div id="tabs">
    <ul>
        <li><a id="tab-2-btn" href="#tabs-2">Private Keys</a></li>
        <li><a id="tab-3-btn" href="#tabs-3">Public Keys</a></li>
    </ul>
    <div id="tabs-2">
        <div id="private_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
    <div id="tabs-3">
        <div id="public_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
    <br/>
    <div id="window_functions" style="width:100%; text-align:right; clear:left;">
        <br/><br/><input type='button' id='close' value='Finished'>
    </div>
</div>
<div id="revkey-confirm" style="display: none;" title="Revoke this Key?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='revkey-text'>Are you sure you wish to revoke this Key?</span></p>
</div>
<div id="revuid-confirm" style="display: none;" title="Revoke this UID?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='revuid-text'>Are you sure you wish to revoke this UID?</span></p>
</div>
<div id="revsig-confirm" style="display: none;" title="Revoke this Signature?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='revsig-text'>Are you sure you wish to revoke this signature?</span></p>
</div>
<div id="delsig-confirm" style="display: none;" title="Delete this Signature?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='delsig-text'>Are you sure you wish to delete this signature?</span></p>
</div>
<div id="deluid-confirm" style="display: none;" title="Delete this UID?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='deluid-text'>Are you sure you want to permenantly delete this UID?</span></p>
</div>
<div id="keyexp-dialog" style="display: none;" title="Change Key Expiration">
    <p><span class="ui-icon ui-icon-calendar" style="float:left; margin:0 7px 20px 0;"></span><span id='keyexp-text'>New Expiration date:</span>
    <div id="keyexp-buttonset" style="margin-bottom: 8px;">
        <input type="radio" name="keyexp-type-radio" id="keyexp-never"/><label for="keyexp-never">Never Expire</label>
        <input type="radio" name="keyexp-type-radio" id="keyexp-ondate"/><label for="keyexp-ondate">Expiration Date</label>
    </div>
    <div style="margin: 0 24px;"><div id="keyexp-date-input"></div></div></p>
</div>
<div id="delete-key-dialog-confirm" style="display: none;" title="Delete this key?">
	<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>This key will be permanently deleted and cannot be undone. Are you sure?</p>
</div>
<div id="createsig-dialog" style="display: none;" title="Sign this UID">
    <form id="createsig-form" style="width: 100%; height: 100px;">

    </form>
</div>
<div id="genkey-dialog" style="display:none;" title="Key Details" style="font-size: 14px;">
    <p>
        <span id='genkey-text'>
        </span>
        <form id="genkey-form" style="width: 100%; height: 100px;">
            <label for='uid_0_name' style='display:inline-block;width:128px;'>Your Name:</label>
             <input type='text' class="ui-corner-all ui-widget ui-state-default" id='uid_0_name' name='uid_0_name' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: John Smith</span><br/>
            <label for='uid_0_email' style='display:inline-block;width:128px;'>Your Email:</label>
            <input type='text' class="ui-corner-all ui-widget ui-state-default" id='uid_0_email' name='uid_0_email' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: john.smith@example.com</span><br/>
            <label for='uid_0_comment' style='display:inline-block;width:128px;'>Comment:</label>
            <input type='text' class="ui-corner-all ui-widget ui-state-default" id='uid_0_comment' name='uid_0_comment' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: for XYZ use only</span><br/>
            <label for='passphrase'  style='display:inline-block;width:132px;' >Passphrase:</label><input class="passphrase ui-corner-all ui-widget ui-state-default" type=password name="passphrase" id="passphrase" onclick="$(this).removeClass('input-error');"/><br/>
            <label for='pass_repeat' style='display:inline-block;width:132px;'>Repeat Passphrase:</label><input class="pass_repeat ui-corner-all ui-widget ui-state-default" type=password name="pass_repeat" id="pass_repeat" onclick="$(this).removeClass('input-error');"/>
            <ul class="expand">
                <li class="trigger"><h4><strong>Advanced Options</strong></h4></li>
                <li>
                    <ul>
                        <li class='option'>
                            <label for='publicKey_algo'>Public Key Algorithm</label>
                            <select id='publicKey_algo' class="key-algo ui-add-hover ui-corner-all ui-widget ui-state-default">
                                <option value="DSA" class="ui-state-default">DSA</option>
                                <option value="RSA" class="ui-state-default" selected>RSA</option>
                            </select>
                        </li>
                        <li class='option'>
                            <label for='publicKey_size'>Public Key Size</label>
                            <select id='publicKey_size' class="key-size ui-add-hover ui-corner-all ui-widget ui-state-default">
                                <option valud="512" class="ui-state-default">512</option>
                                <option value="1024" class="ui-state-default">1024</option>
                                <option value="2048" class="ui-state-default" selected>2048</option>
                                <option value="3072" class="ui-state-default">3072</option>
                                <option value="4096" class="ui-state-default">4096</option>
                            </select>
                        </li>
                        <hr>
                        <li class='option'>
                            <label for='subKey_algo'>Private Key Algorithm</label>
                            <select id='subKey_algo' class="key-algo ui-add-hover ui-corner-all ui-widget ui-state-default">
                                <option value="DSA" class="ui-state-default">DSA</option>
                                <option value="ELG-E" class="ui-state-default">ElGamel</option>
                                <option value="RSA" class="ui-state-default" selected>RSA</option>
                            </select>
                        </li>
                        <li class='option'>
                            <label for='subKey_size'>Private Key Size</label>
                            <select id='subKey_size' class="key-size ui-add-hover ui-button ui-corner-all ui-widget ui-state-default">
                                <option value="512" class="ui-state-default">512</option>
                                <option value="1024" class="ui-state-default">1024</option>
                                <option value="2048" class="ui-state-default" selected>2048</option>
                                <option value="3072" class="ui-state-default">3072</option>
                                <option value="4096" class="ui-state-default">4096</option>
                            </select>
                        </li>
                        <hr>
                        <li class='option'>
                            <label for='expire'>Expire in </label>
                            <select id='key_expire' class="key-expire ui-add-hover ui-corner-all ui-widget ui-state-default">
                                <option value="0" class="ui-state-default">Never</option>
                                <option value="30" class="ui-state-default">30 Days</option>
                                <option value="90" class="ui-state-default" selected>90 days</option>
                                <option value="365" class="ui-state-default">1 year</option>
                            </select>
                        </li>
                    </ul>
                </li>
            </ul>
        </form>
    </p>
</div>
<div id="gensubkey-dialog" style="display:none;" title="Key Details" style="font-size: 14px;">
    <p>
        <span id='gensubkey-text'>
        </span>
        <form id="gensubkey-form" style="width: 100%; height: 100px;">
            <h4><strong>Subkey Options</strong></h4>

            <input type="hidden" name="key_id" id="key_id" class="hidden"/>
            <label for='subKey_algo'>Private Key Algorithm</label>
            <div>
            <select id='subKey_algo' class="subkey-algo ui-add-hover ui-corner-all ui-widget ui-state-default">
                <option value="3" class="ui-state-default">DSA (sign only)</option>
                <option value="4" class="ui-state-default">RSA (sign only)</option>
                <option value="5" class="ui-state-default">Elgamal (encrypt only)</option>
                <option value="6" class="ui-state-default">RSA (encrypt only)</option>
                <option value="7" class="ui-state-default">DSA (set your own capabilities)</option>
                <option value="8" class="ui-state-default" selected>RSA (set your own capabilities)</option>
            </select>
            <div>
            <div id='subKey_flags'>
                <br/>
                <input type="checkbox" id="sign" name="sign" checked/><label for="sign">Sign</label>
                <input type="checkbox" id="enc" name="enc" checked/><label for="enc">Encrypt</label>
                <input type="checkbox" id="auth" name="auth" checked/><label for="auth">Authenticate</label>
                <br/><br/>
            </div>
            <label for='subKey_size'>Private Key Size</label>
            <select id='subKey_size' class="key-size ui-add-hover ui-button ui-corner-all ui-widget ui-state-default">
                <option value="512" class="ui-state-default">512</option>
                <option value="1024" class="ui-state-default">1024</option>
                <option value="2048" class="ui-state-default" selected>2048</option>
                <option value="3072" class="ui-state-default">3072</option>
                <option value="4096" class="ui-state-default">4096</option>
            </select>
            <br/>
            <label for='expire'>Expire in </label>
            <select id='key_expire' class="key-expire ui-add-hover ui-corner-all ui-widget ui-state-default">
                <option value="0" class="ui-state-default" selected>Never</option>
                <option value="30" class="ui-state-default">30 Days</option>
                <option value="90" class="ui-state-default">90 days</option>
                <option value="365" class="ui-state-default">1 year</option>
            </select>
        </form>
    </p>
</div>
<div id="export-dialog" style="display:none;" title="Export Public Key" style="font-size: 14px;">
    <p>
        <span style="margin-top: -18px; margin-left: -8px; width: 100%;" id="export-dialog-msg"></span>
        <textarea id="export-dialog-copytext" style="margin-top: -35px; margin-left: -500px;"></textarea>
        <pre id="export-dialog-text"></pre>
    </p>
</div>
<div id="adduid-dialog" style="display:none;" title="Add UID" style="font-size: 14px;">
    <p>
        <span id='adduid-text'></span>
        <form id="adduid-form" style="width: 100%;">
            <label for='uid_0_name' style='display:inline-block;width:128px;'>Your Name:</label>
            <input type='text' id='uid_0_name' name='uid_0_name' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: John Smith</span><br/>
            <label for='uid_0_email' style='display:inline-block;width:128px;'>Your Email:</label>
            <input type='text' id='uid_0_email' name='uid_0_email' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: john.smith@example.com</span><br/>
            <label for='uid_0_comment' style='display:inline-block;width:128px;'>Comment:</label>
            <input type='text' id='uid_0_comment' name='uid_0_comment' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: uid for XYZ only</span><br/>
        </form>
    </p>
</div>
<div id="dialog-modal" title="">
    <div id="dialog-msg"></div>
</div>
<script src="analytics.js"></script>
</body>
</html>
